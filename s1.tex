\documentclass[10pt]{article}

% amsmath package, useful for mathematical formulas
\usepackage{amsmath}
% amssymb package, useful for mathematical symbols
\usepackage{amssymb}

% graphicx package, useful for including eps and pdf graphics
% include graphics with the command \includegraphics
\usepackage{graphicx}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

\usepackage{color} 

% Use doublespacing - comment out for single spacing
%\usepackage{setspace} 
%\doublespacing


% Text layout
\topmargin 0.0cm
\oddsidemargin 0.5cm
\evensidemargin 0.5cm
\textwidth 16cm 
\textheight 21cm

% Bold the 'Figure #' in the caption and separate it with a period
% Captions will be left justified
\usepackage[labelfont=bf,labelsep=period,justification=raggedright]{caption}

% Use the PLoS provided bibtex style
\bibliographystyle{PLoS2009}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother


% Leave date blank
\date{}

\pagestyle{myheadings}
%% ** EDIT HERE **
%% Please insert a running head of 30 characters or less.  
%% Include it twice, once between each set of braces
\markboth{Evolutionary modeling}{Evolutionary modeling}

%% ** EDIT HERE **
%% PLEASE INCLUDE ALL MACROS BELOW
\input{defs.tex}
% no idea why \outside was redefined with a "\right," instead of a normal comma in defs.tex, but am redefining it back here - IH, 5/29/09
\renewcommand{\outside}[7]{\beta_{#1}\left(#2,#3,#4\right)}
%% END MACROS SECTION

\begin{document}

% Title must be 150 words or less
\begin{flushleft}
  {\Large
    \textbf{\titlestring: \supptext{1}}
  }
\\
\authorstring
\end{flushleft}


\newpage
\tableofcontents


\newpage
\section{Two-sequence transducer models}

We here give formal definitions of two-sequence models and the state machines which
generate the factored probability distribution $P (X, Y | \Delta T) = P (X) \cdot P (Y | X, \Delta T)$,
where the marginal $P(X)$ is generated by a {\bf singlet transducer}
and the conditional $P (Y | X, \Delta T)$ by a {\bf branch transducer}.
We refer to the branch transducer as $\theta$, so the conditional distribution
is more precisely $P (Y | X, \Delta T, \theta)$.


\subsection{Formal grammars} \seclabel{grammars}

There is a close relationship between formal grammars and the singlet and branch transducer abstract state machines.
By labeling the nonterminals of a regular or stochastic context-free grammar (SCFG) as states of an abstract machine, allowing these states to absorb and emit 
appropriate terminal symbols, and carefully assigning transition and emission weights,
we can create a state machine which generates the same language, with the same distribution of weights, as that produced by the original grammar.\footnote{We speak of
weights associated with a transition rather than probabilities in order to allow for more general models.}
We therefore use the terms ``nonterminal'' and ``state'' interchangeably
and refer to the ``parse tree'' generated by singlet and branch transducers.

Phrased more precisely, there is an isomorphism between the singlet and branch transducers of two-sequence models
and Pair SCFGs.  Practically speaking, this means that for every joint distribution $P(X, Y | \Delta T)$ 
generated by a singlet and branch transducers, there exists a Pair SCFG which generates the same distribution.

\subsection{States, transitions and emissions}
A singlet transducer has states of type $\Sstart$ and $\Sinsert$.
Each state $\phi\in\Phi$ of the branch transducer has type
\[ \type(\phi) \in \lbrace\Sstart,\,\Sinsert,\,\Smatch,\,\Swait,\,\Send\rbrace \, . \]
State typing is as follows:
\begin{itemize}
  \item A $\Sstart$ state begins a branch of the parse tree.
  \item An $\Sinsert$ state emits, but does not absorb, symbols.
  \item A $\Smatch$ state absorbs and (possibly) emits symbols.
  \item A $\Swait$ state is a null state which allows a branch transducer to ``pause''
    while it waits for an input symbol from another transducer.
    In the two-sequence case, the input symbols is emitted by the singlet transducer generating
    the ancestral sequence.
  \item An $\Send$ state ends a branch of the parse tree.
\end{itemize}
The names of state types are similar to the $\{\Sstart,\,\Sinsert,\,\Smatch,\,\Send\}$ states of the familiar Pair HMM.
Deletions are handled as a special case by states of type $\Smatch$ which absorb but do not emit symbols pairs.
Only states of type $\Smatch$ can absorb symbol pairs $(x,y)$.

Bifurcations in the grammar, when considered as emission of nonterminals, can be handled analogously
to terminal emission.  States $\phi: \type(\phi) \in \{\Sinsert,\,\Smatch\}$ can emit nonterminal pairs $(c\,d)$,
where $c$ or $d$ can be the null symbol, and the emitted pairs $(c\,d)$ can be absorbed by states of type $\Smatch$.

The emission weight of a nonterminal pair $(c\,d)$ from the state $b: \type(b) = \Smatch$, 
conditional on absorption of a nonterminal pair $(l\,m)$, is 
\[ e_b ( c\,d|l\,m,\theta ) \, . \]

The functions $\emit()$ and $\absorb()$ are defined to return the emission or absorption of a particular state,
\begin{align*}
  \emit(\phi) &:= \left\{\begin{array}{ll} (x,y) & x,y = \mathrm{terminal\,\,or\,\,null} \\(c\,d) & c,d = \mathrm{nonterminal\,\,or\,\,null}. \end{array} \right. \\
  \absorb(\phi) &:= \left\{\begin{array}{ll} (x,y) & x,y = \mathrm{terminal\,\,or\,\,null} \\(c\,d) & c,d = \mathrm{nonterminal\,\,or\,\,null}. \end{array} \right.
\end{align*}

We frequently use the notation ${}^{uv}\phi^{xy}$ to indicate that a state of type $\Smatch$ absorbs a symbol pair $(u,v)$
and emits a pair $(x,y)$.
The notation for bifurcations is slightly different:
A bifurcation state which left-emits a nonterminal $d$ and makes a transition to a state $\phi$ with weight 1 is written as $\bifurc{B}{d}{\phi}$.

A transition between states $a$ and $b$ of the branch transducer $\theta$ has a weight
\[ t(a,b|\theta) = t(a \to b|\theta). \]
Terminal emission is handled by states $\phi: \type(\phi) \in \{\Smatch,\,\Sinsert\}$, which emit symbol pairs $(x,y)$,
where $x$ or $y$ can be the null symbol.
In this paired-emission perspective, left single-terminal emissions $x$ are represented as $(x\,\Tnull)$;
right single-terminal emissions are handled similarly.
The weight of an emission of a terminal pair $(x,y)$ from a state $b: \type(b) = \Smatch$, 
conditioned on absorption of a terminal pair $(u,v)$, is 
\[ e_b ( x,y|u,v,\theta ) \, . \]
Recall that the emission weights of states of type $\Smatch$ are defined conditioned upon the absorbed symbols.


\newpage
\section{Multiple-sequence transducer models} \seclabel{evolutionarymodels}

We can use our two-sequence models to construct a model of many sequence related by a
guide phylogenetic tree.
The guide tree specifies the (conjectured) phylogenetic relationship of all sequences.
A singlet transducer, which emits, but does not absorb, symbols, lies at the root of the guide tree and 
serves as a generative model of the ancestral sequence.
A branch transducer represents the evolution of an ancestral sequence into a single descendant 
sequence, that is, the action of evolution along the single-branch tree (Ancestor $\to$ Descendant).
To represent the evolution of an ancestral sequence into many descendant sequences
(whose phylogenetic relationship is specified by the guide tree),
we place a branch transducer on each branch of the guide tree to create a multiple-sequence model.

If the branch grammar has no bifurcations and only left or right emissions are allowed, then
the language generated is a regular string language and the corresponding jointly normalized abstract state machine is 
an HMM.  In this simplest case our formalism for creating a multiple-sequence model reduces to that given 
by \cite{Holmes2003} for combining HMMs on a guide tree.


\subsection{The guide tree}
The nodes of the tree are labeled $1,\dots,N$ in the order reached by any preorder depth-first traversal of the tree.
The length of each branch $(\parent(m) \to m)$ is given by the evolutionary time $t_m$.
To specify ancestor-descendant relationships, we introduce notation:
$\mDn$ ($\mNDn$) means node $m$ is descended from (not descended from) node $n$, and
$\mDEn$ ($\mNDEn$) means node $m$ is descended from or identical to (not descended from and not identical to) node $n$.

\subsection{States, transitions and emissions}
The multiple-sequence model is formed by the composition/intersection of $(N-1)$ branch transducers 
such that there is a branch transducer on each branch $(\parent(m) \to m);\, m = 2,\dots,N$ of the guide tree and a singlet transducer at the root node.
Our framework allows for the placement of different branch transducers, with a unique set of nonterminals (state space) $\Phi$ and
allowed transitions between states and corresponding weights, on each branch.  $\theta^{(m)}$ denotes 
the branch transducer governing evolution along the branch $(\parent(m) \to m)$ of the guide tree.

States of the multiple-sequence model are represented by as N-dimensional vectors $\bvec{a}$,
\[ \bvec{a} = \statevec{a} \, . \]
These states are typed as
\[ \type(\bvec{a}) \in \lbrace\Sstart,\,\Semit,\,\Sbifurc,\,\Snull,\,\Send\rbrace \, . \]
State typing is as follows:
\begin{itemize}
  \item A $\Sstart$ state begins a branch of the parse tree of one or more of the $N$ sequences on the phylogenetic tree.
  \item An $\Semit$ state emits symbols (terminals) to one or more of the $N$ sequences.
  \item A $\Sbifurc$ state corresponds to a bifurcation in the parse tree of
    one or more of the $N$ sequences.
  \item A $\Snull$ state corresponds to any non-$\Send$ state which represents neither
    an emission or bifurcation.
  \item An $\Send$ state ends a branch of the parse tree.
\end{itemize}
States are typed according to the transition by which they are reachable
(details of the typing are given in \secref{transitions}).

Transitions and emissions of the multiple-sequence model are defined in terms of the transitions and emissions 
of the branch transducers at each node as well as the singlet transducer at the root node.
The weight of a transition $\bvec{a} \to \bvec{b}$ is therefore
\beqn
t(\bvec{a},\bvec{b}) = \prod_{m|a_m \ne b_m} \transweight{m}{a_m}{b_m} \, ,
\eeqn
and the weight of an emission $(\bvec{x}\,\bvec{y})$ from a state $\bvec{b}$ is
\beqn
\totalemissionweight{\bvec{b}}{\bvec{x}\,\bvec{y}} = \prod_m e_{b_m}\left(x_m\,y_m|x_{\parent(m)}\,y_{\parent(m)},\theta^{(m)}\right) \, .
\eeqn
We frequently will not explicitly write out the conditional dependence on the absorbed terminals $(x_{\parent(m)}\,y_{\parent(m)})$,
but the reader should keep in mind that in general emission weights will depend on the absorbed symbols.

\subsection{Formal grammars} \seclabel{multigrammars}

Analogously to the case with two-sequence models (\secref{grammars}),
there exists a one-to-one mapping between the multiple-sequence models generated by our model-construction algorithm 
and multi-sequence SCFGs.
In other words, given a singlet and branch transducers of a two-sequence model, as well
as a guide tree relating the extant sequences, there exists a corresponding multi-sequence SCFG
which generates the same joint probability distribution $P(X_1 , ... , X_n)$.



\subsection{Constructing the state graph} \seclabel{stategraph}

As described in the paper,
we need a way to efficiently construct the state graph of the multi-sequence model,
where the state graph consists of a list of accessible states and the possible transitions between them.
This state graph can be constructed by an uninformed depth-first search,
where at each step of the search we obtain the possible child nodes 
by applying one of the following possible transitions of the multi-sequence model:
\begin{enumerate}
\item {\bf Null transition}:
  The state of a single branch transducer is updated, with no terminal emission or bifurcation.
\item {\bf Terminal emission}:
  A state makes a transition to a $\Sinsert$ state.  The emitted symbol is passed down the guide
  tree to all descendant branch transducers, which transition to states of type $\Smatch$.
\item {\bf Bifurcation}:
  A state makes a transition to a special $\Sinsert$ state which emits a new branch of the parse tree.
  The emitted symbol is passed down the guide tree to all descendant branch transducers, 
  which transition to states of type $\Smatch$.
\item {\bf End transition}:
  The singlet transducer associated with the root sequence can transition to the $\Send$ state,
  signaling that this parse tree is finished.
\end{enumerate}

Each of these transitions is explained in detail in the following section.



\subsection{Allowed transitions} \seclabel{transitions}

Following \cite{Holmes2003},  we let transitions of the multi-sequence model begin at the active node and cascade down the guide tree
as appropriate.  Unless defined otherwise, node $n$ is the active node of the multi-sequence model with state $\bvec{a}$, 
\begin{align}
  n &= \activenode{a} \\
  &= \mathrm{argmax}_m \left\{\type(a_m) \notin \{\Swait,\,\Send\}\right\} \, . \label{eqn:activenode} 
\end{align}
Each possible allowed transition is obtained by making a valid change (updating) the 
state of the singlet or one or more of the branch transducers of the multi-sequence model.


\subsubsection*{Null Transitions}

\[ \statevec{a} \to \statevec{b} \]

\begin{align} \label{eqn:nulltransition}
  \type(\bvec{b}) &= \Snull  \\
  \weight(\bvec{a}\to\bvec{b}) &= t(\bvec{a},\bvec{b}) \\
  &= \transweight{n}{a_n}{b_n} .
\end{align}

This transition updates the state of the branch transducer at the active node $n$ of the guide tree, leaving 
the rest unchanged, with no corresponding terminal emission or bifurcation in the grammar.
Nodes other than the active node do not change state, $a_m = b_m \,\forall\, m \ne n$, and the only 
allowable transitions of this form are to states $b_n:\,\type(b_n) \in \{\Sstart,\,\Swait\}$.  Transitions
to states of type $\Sinsert$ or $\Smatch$ result in emissions, and transitions to the end state $\Send$
are handled as a special case.


\subsubsection*{Terminal Emission} \seclabel{terminalemission}
\[ \statevec{a} \to \statevec{x}\,\statevec{b}\,\statevec{y} \]

\begin{align} \label{eqn:terminalemission}
  \type(\bvec{b}) &= \Semit \\
  \weight(\bvec{a}\to\bvec{x}\,\bvec{b}\,\bvec{y}) &=  t(\bvec{a},\bvec{b}) \cdot \totalemissionweight{\bvec{b}}{\bvec{x}\,\bvec{y}} \\
  &= \left[ \prod_{m|a_m \ne b_m} \transweight{m}{a_m}{b_m} \right] \cdot \left[ \prod_m \emissionweight{m}{b_m}{x_m\,y_m} \right] ,
\end{align}
where we are defining states with no emissions to emit $(\Tnull\,\Tnull)$ with weight 1, 
$\emissionweight{m}{b_m}{x_m\,y_m} = 1$ if $(x_m\,y_m) = (\Tnull\,\Tnull)$ and $\emit(b_m) = \Tnull$.

The active node $n$ makes a transition to a state $b_n:\,\type(b_n) = \Sinsert$, emitting
a terminal symbol pair $\emit(b_n) = (x_n\,y_n)$.  This symbol pair is passed down the guide tree to descendant nodes $\{m|\mDn, \type(a_m) \ne \Send\}$, 
forcing them to make a transition from states of type $\Swait$ to states of type $\Smatch$, which can absorb
terminal pairs $(x,y)$.  Qualitatively, this transition and emission could represent the evolution
of two paired nucleotides along the subtree rooted at node $n$ of the complete guide tree.
If one of $\bvec{x}$ or $\bvec{y}$ is null, then \eqref{eqn:terminalemission} could represent the evolution of
a single unpaired nucleotide along the subtree rooted at node $n$.


\paragraph{Left emission.}
All terminals $\bvec{y}$ in the transition $\bvec{a} \to \bvec{x}\,\bvec{b}\,\bvec{y}$ \eqref{eqn:terminalemission} are null.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(x_m\,y_m) = (\Tgap\,\Tnull)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(x_n\,y_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m) = (x_{\parent(m)}\,\Tnull)$. \\
  & $(x_m\,y_m) = \left\{ \begin{array}{ll} (\Tgap\,\Tnull) & \emit(b_m) = \Tnull \\ \emit(b_m) & \emit(b_m) \ne \Tnull \end{array} \right. $
\end{tabular}

\paragraph{Right emission.}
All terminals $\bvec{x}$ in the transition $\bvec{a} \to \bvec{x}\,\bvec{b}\,\bvec{y}$ \eqref{eqn:terminalemission} are null.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(x_m\,y_m) = (\Tnull\,\Tgap)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(x_n\,y_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m) = (\Tnull\,y_{\parent(m)})$. \\
  & $(x_m\,y_m) = \left\{ \begin{array}{ll} (\Tnull\,\Tgap) & \emit(b_m) = \Tnull \\ \emit(b_m) & \emit(b_m) \ne \Tnull . \end{array} \right. $
\end{tabular}

\paragraph{Paired emission.}

There is at least one non-null terminal in both $\bvec{x}$ and $\bvec{y}$ in the transition $\bvec{a} \to \bvec{x}\,\bvec{b}\,\bvec{y}$ \eqref{eqn:terminalemission}.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(x_m\,y_m) = (\Tgap\,\Tgap)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(x_n\,y_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m) = (x_{\parent(m)}\,y_{\parent(m)})$. \\
  & $(x_m\,y_m) = \left\{ \begin{array}{ll} (\Tgap\,\Tgap) & \emit(b_m) = \Tnull \\ \emit(b_m) & \emit(b_m) \ne \Tnull . \end{array} \right. $
\end{tabular}


\subsubsection*{Bifurcations}
\[ \statevec{a} \to \statevec{c}\,\statevec{b}\,\statevec{d} \]

\begin{align} \label{eqn:nonterminalemission}
  \type(\bvec{b}) &= \Sbifurc \\
  \weight(\bvec{a}\to\bvec{c}\,\bvec{b}\,\bvec{d}) &=  t(\bvec{a},\bvec{b}) \cdot \totalemissionweight{\bvec{b}}{\bvec{c}\,\bvec{d}} \\
  &= \left[ \prod_{m|\,a_m \ne b_m} \transweight{m}{a_m}{b_m} \right] \cdot \left[ \prod_m \emissionweight{m}{b_m}{c_m\,d_m} \right] .
\end{align}
where we are defining the emission weight of the $\Send$ nonterminal to be 1, $\emissionweight{m}{b_m}{c_m\,d_m} = 1$ if $c_m = \Send$ or $d_m = \Send$.

Bifurcations are handled similarly to terminal emission.  The active node $n$ can undergo a bifurcation by making a transition 
$a_n \to b_n,\, b_n:\,\type(b_n) = \Sinsert$, emitting a pair of nonterminals $\emit(b_n) = (c_n\,d_n)$.  Descendant nodes $\{m|\mDn,\type(a_m) \ne \Send\}$
are forced to make a transition from states of type $\Swait$ to states of type $\Smatch$ which can absorb nonterminal pairs $(c\,d)$.
All emissions are pairwise, so left and right bifurcations are represented as pairs $(\bvec{c}\,\bvec{d})$ where either $\bvec{c}$ or $\bvec{d}$ is null.
If $\bvec{d}$ is null, then \eqref{eqn:nonterminalemission} could represent the insertion and subsequent evolution of a new RNA stem-loop structure.

\paragraph{Left bifurcation.}
All nonterminals $\bvec{d}$ in the transition $\bvec{a} \to \bvec{c}\,\bvec{b}\,\bvec{d}$ \eqref{eqn:nonterminalemission} are null.
The nonterminals $\bvec{c}$ are the ``new'' states (for example, corresponding to a newly formed stem);
the nonterminals $\bvec{b}$ are the states which will generate the (evolved) ancestral sequence.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(c_m\,d_m) = (\Send\,\Tnull)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(c_n\,d_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m)$ \\
  & $(c_m\,d_m) = \emit(b_m) . $
\end{tabular}


\paragraph{Right bifurcation.}
All nonterminals $\bvec{c}$ in the transition $\bvec{a} \to \bvec{c}\,\bvec{b}\,\bvec{d}$ \eqref{eqn:nonterminalemission} are null.
The nonterminals $\bvec{d}$ are the ``new'' states;
the nonterminals $\bvec{b}$ are the states which will generate the (evolved) ancestral sequence.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(c_m\,d_m) = (\Tnull\,\Send)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(c_n\,d_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m)$ \\
  & $(c_m\,d_m) = \emit(b_m) . $
\end{tabular}

\paragraph{Paired bifurcation}
There is at least one non-null nonterminal in both $\bvec{c}$ and $\bvec{d}$ in the transition $\bvec{a} \to \bvec{c}\,\bvec{b}\,\bvec{d}$ \eqref{eqn:nonterminalemission}.
The nonterminals $\bvec{c}$ and $\bvec{d}$ are both ``new'' states;
the nonterminals $\bvec{b}$ are the states which will generate the (evolved) ancestral sequence.

\begin{tabular}{rl}
  Nodes $\mNDEn$: & $a_m = b_m$. \\
  & $(c_m\,d_m) = (\Send\,\Send)$. \\
  Node $n$: & $b_n:\,\type(b_n) = \Sinsert,\,\exists$ a transition $a_n \to b_n$ in the branch transducer $\theta^{(n)}$. \\
  & $(c_n\,d_n) = \emit(b_n)$. \\
  Nodes $\mDn$: & Either $a_m = b_m$, $\emit(b_{\parent(m)}) = \Tnull$ or $\type(a_m) = \Send$ \\
  & $\quad$ or $\emit(b_{\parent(m)}) = \absorb(b_m)$ \\
  & $(c_m\,d_m) = \emit(b_m) . $
\end{tabular}

This paired-bifurcation is included for completeness--for example, it could be used to model symmetric loops--but it
increases the complexity of grammar parsing.



\subsubsection*{Transition to $\Send$}
\[ \statevec{a} \to \Send \]

\begin{align} \label{eqn:transtoend}
  \weight(\bvec{a}\to\Send) &=  t(\bvec{a},\Send) \\
  &= \prod_{m|\type(a_m)\ne\Send} \transweight{m}{a_m}{\Send} .
\end{align}

The singlet transducer associated with the highest active ancestral node,
\beqn
\hat{n} = \argmin_m \left\{ \type(a_m) \in \{\Sstart,\,\Sinsert\} \right\}
\eeqn
can make a transition to the state $\Send$,
forcing the entire multi-sequence model to transition to $\Send$.\footnote{The node $\hat{n}$ which initiates the transition to $\Send$ 
is the root of the greatest active subtree of the whole guide tree (called such because $a_m = \Send \, \forall \, m \ntrianglerighteq \hat{n}$).}
If the branch transducer does not permit inserted bifurcations then $\hat{n} = 1$ always,
but this is generically not true for a more general grammar
(for example, see the TKF Structure Tree model).

We require:

\begin{tabular}{rl}
  Nodes $m \ntrianglerighteq \hat{n}$: & $a_m = \Send$. \\
  Node $\hat{n}$: & $\type(a_{\hat{n}}) \in \{\Sstart,\,\Sinsert\}$ \\
  & $\exists$ a transition $a_{\hat{n}} \to \Send$.  \\
  Nodes $m \vartriangleright \hat{n}$: & $\type(a_m) = \Swait$ \\
  & $\exists$ a transition $a_m \to \Send$. \\
\end{tabular}

In many probabilistic models, the transition from a state of type $\Swait$ to the $\Send$ state has weight 1 conditional on absorbing 
the $\Send$ symbol (called $\epsilon$ in formal grammar theory),
but we here allow for a more general contribution to the total weight $\mathbb{F}$ of the transition.

$\hat{n}$ and $\weight(\bvec{a}\to\Send)$ are so defined in order to ensure that there exists a direct path
along which the end symbol can be passed down the tree.
The grammar should be designed such that if the singlet transducer at node $\hat{n}$ can make a transition to $\Send$,
then so can all machines at $\{m|m \trianglerighteq \hat{n}\}$.
The TKF Structure Tree model satisfies this condition.
A more general approach is probably possible, but it involves summing over paths $a': a_m \to a' \to \Send$,
handling possible bifurcations in these paths, etc.




\bibliography{../latex-inputs/alignment,../latex-inputs/reconstruction,../latex-inputs/duplication,../latex-inputs/genomics,../latex-inputs/ncrna,../latex-inputs/url}



\end{document}
